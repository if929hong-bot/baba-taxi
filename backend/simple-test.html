<!DOCTYPE html>
<html>
<head>
    <title>WebSocket ç°¡å–®æ¸¬è©¦</title>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
</head>
<body>
    <h2>WebSocket é€£ç·šæ¸¬è©¦</h2>
    <div id="status">æ¸¬è©¦ä¸­...</div>
    <div id="log"></div>

    <script>
        const log = document.getElementById('log')
        const statusDiv = document.getElementById('status')
        
        function addLog(msg) {
            log.innerHTML += '<div>' + new Date().toLocaleTimeString() + ' - ' + msg + '</div>'
        }

        addLog('é–‹å§‹é€£ç·šåˆ° ws://localhost:3000...')
        
        // å…ˆå˜—è©¦ç”¨ WebSocket å–å¾— token
        async function getToken() {
            try {
                const response = await fetch('http://localhost:3000/api/super/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        phone: '0975521219',
                        password: 'sgm0975521219'
                    })
                })
                const data = await response.json()
                if (data.success) {
                    addLog('âœ… å–å¾— token æˆåŠŸ')
                    return data.data.token
                } else {
                    addLog('âš ï¸ å–å¾— token å¤±æ•—ï¼Œä½¿ç”¨æ¸¬è©¦ token')
                    return 'test-token'
                }
            } catch (error) {
                addLog('âš ï¸ ç„¡æ³•å–å¾— tokenï¼Œä½¿ç”¨æ¸¬è©¦ token')
                return 'test-token'
            }
        }

        // å»ºç«‹ WebSocket é€£ç·š
        getToken().then(token => {
            addLog('ä½¿ç”¨ token: ' + token.substring(0, 20) + '...')
            
            const socket = io('http://localhost:3000', {
                transports: ['websocket', 'polling'], // å…è¨±å…©ç¨®å‚³è¼¸æ–¹å¼
                auth: { token: token },
                reconnection: true,
                reconnectionAttempts: 5,
                reconnectionDelay: 1000
            })

            socket.on('connect', () => {
                statusDiv.innerHTML = 'âœ… å·²é€£ç·šï¼'
                statusDiv.style.color = 'green'
                addLog('âœ… WebSocket é€£ç·šæˆåŠŸï¼')
                
                // æ¸¬è©¦ç™¼é€è¨Šæ¯
                socket.emit('test-message', { msg: 'Hello Server!' })
            })

            socket.on('connect_error', (err) => {
                statusDiv.innerHTML = 'âŒ é€£ç·šå¤±æ•—'
                statusDiv.style.color = 'red'
                addLog('âŒ é€£ç·šéŒ¯èª¤ï¼š' + err.message)
                
                // å˜—è©¦ç”¨ä¸åŒçš„ token é‡é€£
                if (err.message.includes('èªè­‰')) {
                    addLog('ðŸ”„ å˜—è©¦ä½¿ç”¨å‚™ç”¨ token...')
                    setTimeout(() => {
                        socket.auth.token = 'test-token'
                        socket.connect()
                    }, 2000)
                }
            })

            socket.on('disconnect', (reason) => {
                statusDiv.innerHTML = 'ðŸ”´ å·²æ–·ç·š'
                statusDiv.style.color = 'orange'
                addLog('ðŸ”´ å·²æ–·ç·šï¼ŒåŽŸå› ï¼š' + reason)
            })

            socket.on('test-response', (data) => {
                addLog('ðŸ“¨ æ”¶åˆ°ä¼ºæœå™¨å›žæ‡‰ï¼š' + JSON.stringify(data))
            })

            // æŽ¥æ”¶å„ç¨®äº‹ä»¶
            socket.onAny((event, ...args) => {
                addLog(`ðŸ“¡ äº‹ä»¶ ${event}: ${JSON.stringify(args)}`)
            })
        })
    </script>
</body>
</html>