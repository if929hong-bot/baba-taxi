// 資料庫連線設定
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
}

// ==================== 超級管理員 ====================
model SuperAdmin {
  id        String   @id @default(cuid())
  phone     String   @unique // 帳號
  password  String // 加密儲存
  name      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // 關聯
  reviewedFleets    FleetManager[] @relation("reviewedBy")
  confirmedPayments RentPayment[]  @relation("confirmedBy")
  bankUpdates       BankInfo[]     @relation("updatedBy")

  @@map("super_admins")
}

// ==================== 車隊 ====================
model Fleet {
  id            String   @id @default(cuid())
  fleetCode     String   @unique // 車隊編號，如：F001
  fleetName     String   @unique
  status        String   @default("pending") // pending, active, suspended
  createdAt     DateTime @default(now())
  suspendedAt   DateTime?
  suspendReason String?

  // 關聯
  managers FleetManager[]
  drivers  Driver[]
  payments RentPayment[]
  settings FleetSettings?
  orders   Order[]

  @@map("fleets")
}

// ==================== 車隊管理員 ====================
model FleetManager {
  id      String @id @default(cuid())
  fleetId String
  fleet   Fleet  @relation(fields: [fleetId], references: [id], onDelete: Cascade)

  name     String
  phone    String   @unique
  email    String   @unique
  password String
  status   String   @default("pending") // pending, active, blocked

  resetToken       String?
  resetTokenExpiry DateTime?
  lastLogin        DateTime?
  createdAt        DateTime @default(now())

  // 誰審核的
  reviewedBy String?
  reviewer   SuperAdmin? @relation("reviewedBy", fields: [reviewedBy], references: [id])
  reviewedAt DateTime?

  @@map("fleet_managers")
}

// ==================== 車隊設定 ====================
model FleetSettings {
  id      String @id @default(cuid())
  fleetId String @unique
  fleet   Fleet  @relation(fields: [fleetId], references: [id], onDelete: Cascade)

  // 費率設定
  baseFare   Int   @default(85) // 起跳價
  perKmRate  Float @default(20.0) // 每公里收費
  perMinRate Float @default(5.0) // 每分鐘等待費
  minFare    Int   @default(100) // 最低收費

  // 夜間加成
  nightSurcharge Int?    @default(20)
  nightStart     String? @default("23:00")
  nightEnd       String? @default("06:00")

  updatedAt DateTime @updatedAt

  @@map("fleet_settings")
}

// ==================== 銀行資訊（全平台共用）====================
model BankInfo {
  id            Int    @id @default(1) // 固定只有一筆
  bankName      String
  branch        String
  accountName   String
  accountNumber String

  updatedBy String
  updater   SuperAdmin @relation("updatedBy", fields: [updatedBy], references: [id])
  updatedAt DateTime   @updatedAt

  @@map("bank_info")
}

// ==================== 租金繳費 ====================
model RentPayment {
  id      String @id @default(cuid())
  fleetId String
  fleet   Fleet  @relation(fields: [fleetId], references: [id], onDelete: Cascade)

  month    String // YYYY-MM
  amount   Int
  proofUrl String // 繳費證明圖片網址
  status   String @default("pending") // pending, confirmed

  confirmedBy String?
  confirmer   SuperAdmin? @relation("confirmedBy", fields: [confirmedBy], references: [id])
  confirmedAt DateTime?

  remarks   String?
  createdAt DateTime @default(now())

  @@unique([fleetId, month])
  @@map("rent_payments")
}

// ==================== 司機 ====================
model Driver {
  id      String @id @default(cuid())
  fleetId String
  fleet   Fleet  @relation(fields: [fleetId], references: [id], onDelete: Cascade)

  driverCode String @unique // 格式：F001-D001

  // 基本資料
  name     String
  phone    String  @unique
  email    String?
  password String

  // 車輛資料
  licensePlate String @unique
  carBrand     String // 車款
  carModel     String // 車型
  carYear      Int
  carColor     String

  // 保險
  hasInsurance Boolean @default(false)

  // 背景資料
  experience     String? // 有無經驗/待過車隊
  currentJob     String? // 目前職業
  selfScore      Int? // 自評分數 1-10
  criminalRecord String? @default("無")

  // 文件（儲存圖片網址）
  driverLicenseUrl     String? // 駕照照片
  carPhotosUrls        String // 車子照片陣列（存成 JSON 字串）
  policeCertificateUrl String? // 良民證

  // 狀態
  status       String @default("pending") // pending, active, blocked
  onlineStatus String @default("offline") // online, offline

  // 即時位置
  lastLatitude       Float?
  lastLongitude      Float?
  lastLocationUpdate DateTime?

  // 統計
  rating      Float @default(0)
  totalTrips  Int   @default(0)
  totalIncome Int   @default(0)

  resetToken       String?
  resetTokenExpiry DateTime?
  lastLogin        DateTime?
  createdAt        DateTime @default(now())

  // 誰審核的
  reviewedBy String?
  reviewedAt DateTime?

  // 關聯
  orders    Order[]
  locations DriverLocation[]

  @@map("drivers")
}

// ==================== 司機即時位置 ====================
model DriverLocation {
  id       String @id @default(cuid())
  driverId String @unique
  driver   Driver @relation(fields: [driverId], references: [id], onDelete: Cascade)

  latitude  Float
  longitude Float
  updatedAt DateTime @updatedAt

  @@map("driver_locations")
}

// ==================== 乘客 ====================
model Passenger {
  id    String @id @default(cuid())
  phone String @unique // 用電話號碼當作唯一識別

  // 統計用（可不儲存個資）
  totalTrips Int @default(0)

  // 關聯
  orders Order[]

  @@map("passengers")
}

// ==================== 訂單 ====================
model Order {
  id          String @id @default(cuid())
  orderNumber String @unique // 訂單編號，如：ORD-20260214-001

  fleetId String
  fleet   Fleet @relation(fields: [fleetId], references: [id])

  driverId String?
  driver   Driver? @relation(fields: [driverId], references: [id])

  passengerId String?
  passenger   Passenger? @relation(fields: [passengerId], references: [id])

  // 乘客資訊（免登入時使用）
  passengerPhone String

  // 地點
  pickupAddress String
  pickupLat     Float?
  pickupLng     Float?

  dropoffAddress String?
  dropoffLat     Float?
  dropoffLng     Float?

  // 費用
  estimatedFare Int?
  actualFare    Int?
  paymentMethod String? // cash, street

  // 狀態
  status String @default("pending") // pending, matching, accepted, picked_up, completed, cancelled

  // 時間
  requestedTime DateTime @default(now())
  acceptedTime  DateTime?
  pickedUpTime  DateTime?
  completedTime DateTime?
  cancelledTime DateTime?

  // 距離
  distanceKm  Float?
  durationMin Int?

  // 備註
  note String?

  // 關聯
  tracking OrderTracking?

  @@map("orders")
}

// ==================== 訂單追蹤 ====================
model OrderTracking {
  id      String @id @default(cuid())
  orderId String @unique
  order   Order  @relation(fields: [orderId], references: [id], onDelete: Cascade)

  driverLat Float
  driverLng Float
  updatedAt DateTime @updatedAt

  @@map("order_trackings")
}