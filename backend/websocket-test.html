<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>å­å­å‡ºè¡Œ - WebSocket æ¸¬è©¦</title>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h2 {
            color: #333;
            border-bottom: 2px solid #6b46c1;
            padding-bottom: 10px;
        }
        .role-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        .role-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            background: #e0e0e0;
        }
        .role-btn.active {
            background: #6b46c1;
            color: white;
        }
        .status {
            background: #f0f0f0;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        .event-log {
            background: #1e1e1e;
            color: #00ff00;
            padding: 10px;
            border-radius: 5px;
            height: 200px;
            overflow-y: auto;
            font-family: monospace;
            margin-bottom: 20px;
        }
        .event {
            margin: 5px 0;
            padding: 5px;
            border-bottom: 1px solid #333;
        }
        .controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        button {
            padding: 8px 16px;
            background: #6b46c1;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        button:hover {
            background: #553c9a;
        }
        input, textarea {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
            flex: 1;
        }
        .form-group {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h2>ğŸ”Œ å­å­å‡ºè¡Œ WebSocket æ¸¬è©¦</h2>
        
        <div class="role-selector">
            <button class="role-btn" onclick="setRole('driver')">ğŸš— å¸æ©Ÿ</button>
            <button class="role-btn" onclick="setRole('passenger')">ğŸ‘¤ ä¹˜å®¢</button>
            <button class="role-btn" onclick="setRole('fleet')">ğŸ¢ è»ŠéšŠç®¡ç†å“¡</button>
            <button class="role-btn" onclick="setRole('super')">ğŸ‘‘ è¶…ç´šç®¡ç†å“¡</button>
        </div>

        <div class="status" id="status">
            æœªé€£ç·š
        </div>

        <div class="event-log" id="eventLog">
            <div class="event">ğŸ“‹ äº‹ä»¶è¨˜éŒ„å°‡é¡¯ç¤ºåœ¨é€™è£¡...</div>
        </div>

        <div id="driverControls" style="display: none;">
            <h3>å¸æ©Ÿæ§åˆ¶</h3>
            <div class="form-group">
                <input type="text" id="latitude" placeholder="ç·¯åº¦" value="25.0330">
                <input type="text" id="longitude" placeholder="ç¶“åº¦" value="121.5654">
                <button onclick="updateLocation()">æ›´æ–°ä½ç½®</button>
            </div>
            <div class="form-group">
                <button onclick="goOnline()">ğŸŸ¢ ä¸Šç·š</button>
                <button onclick="goOffline()">ğŸ”´ ä¸‹ç·š</button>
            </div>
            <div class="form-group">
                <input type="text" id="orderId" placeholder="è¨‚å–®ID">
                <button onclick="acceptOrder()">âœ… æ¥å—è¨‚å–®</button>
            </div>
        </div>

        <div id="passengerControls" style="display: none;">
            <h3>ä¹˜å®¢æ§åˆ¶</h3>
            <div class="form-group">
                <input type="text" id="passengerOrderId" placeholder="è¨‚å–®ID">
                <button onclick="trackOrder()">ğŸ“ è¿½è¹¤è¨‚å–®</button>
            </div>
        </div>

        <div id="fleetControls" style="display: none;">
            <h3>è»ŠéšŠç®¡ç†å“¡æ§åˆ¶</h3>
            <div class="form-group">
                <button onclick="requestFleetStats()">ğŸ“Š å–å¾—è»ŠéšŠçµ±è¨ˆ</button>
            </div>
        </div>
    </div>

    <script>
        let socket = null
        let currentRole = null
        let token = null

        // æ¨¡æ“¬ç™»å…¥å–å¾— tokenï¼ˆå¯¦éš›æ‡‰ç”¨ä¸­éœ€è¦å…ˆç™»å…¥ï¼‰
        function getToken(role) {
            // é€™è£¡æ‡‰è©²å¾ç™»å…¥ API å–å¾—çœŸå¯¦ token
            return 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6InRlc3QtaWQiLCJyb2xlIjoiZ3Vlc3QifQ.test-signature'
        }

        function setRole(role) {
            currentRole = role
            document.querySelectorAll('.role-btn').forEach(btn => btn.classList.remove('active'))
            event.target.classList.add('active')
            
            // éš±è—æ‰€æœ‰æ§åˆ¶é …
            document.getElementById('driverControls').style.display = 'none'
            document.getElementById('passengerControls').style.display = 'none'
            document.getElementById('fleetControls').style.display = 'none'
            
            // é¡¯ç¤ºå°æ‡‰æ§åˆ¶é …
            if (role === 'driver') {
                document.getElementById('driverControls').style.display = 'block'
            } else if (role === 'passenger') {
                document.getElementById('passengerControls').style.display = 'block'
            } else if (role === 'fleet') {
                document.getElementById('fleetControls').style.display = 'block'
            }

            connectWebSocket(role)
        }

        function connectWebSocket(role) {
            if (socket) {
                socket.disconnect()
            }

            token = getToken(role)
            
            socket = io('http://localhost:3000', {
                auth: { token },
                query: { role }
            })

            socket.on('connect', () => {
                addEvent('âœ… å·²é€£ç·šåˆ° WebSocket ä¼ºæœå™¨', 'success')
                document.getElementById('status').innerHTML = 'ğŸŸ¢ å·²é€£ç·š'
            })

            socket.on('disconnect', () => {
                addEvent('âŒ å·²æ–·ç·š', 'error')
                document.getElementById('status').innerHTML = 'ğŸ”´ æœªé€£ç·š'
            })

            socket.on('error', (error) => {
                addEvent(`âš ï¸ éŒ¯èª¤ï¼š${error}`, 'error')
            })

            // å¸æ©Ÿç«¯äº‹ä»¶
            socket.on('order:new', (data) => {
                addEvent(`ğŸš— æ–°è¨‚å–®ï¼š${data.orderNumber} - ${data.pickupAddress}`, 'info')
            })

            socket.on('order:accepted', (data) => {
                addEvent(`âœ… è¨‚å–®å·²è¢«æ¥å—ï¼š${data.orderId}`, 'success')
            })

            // ä¹˜å®¢ç«¯äº‹ä»¶
            socket.on('driver:location-update', (data) => {
                addEvent(`ğŸ“ å¸æ©Ÿä½ç½®æ›´æ–°ï¼š${data.latitude}, ${data.longitude}`, 'info')
            })

            socket.on('order:status-update', (data) => {
                addEvent(`ğŸ”„ è¨‚å–®ç‹€æ…‹æ›´æ–°ï¼š${data.orderId} -> ${data.status}`, 'info')
            })

            // è»ŠéšŠç®¡ç†å“¡äº‹ä»¶
            socket.on('fleet:stats', (data) => {
                addEvent(`ğŸ“Š è»ŠéšŠçµ±è¨ˆ - ç·šä¸Šå¸æ©Ÿï¼š${data.onlineDrivers}ï¼Œé€²è¡Œä¸­è¨‚å–®ï¼š${data.activeOrders}`, 'info')
            })

            // è¶…ç´šç®¡ç†å“¡äº‹ä»¶
            socket.on('platform:stats', (data) => {
                addEvent(`ğŸ“ˆ å¹³å°çµ±è¨ˆ - è»ŠéšŠï¼š${data.totalFleets}ï¼Œå¸æ©Ÿï¼š${data.totalDrivers}ï¼Œè¨‚å–®ï¼š${data.totalOrders}`, 'info')
            })
        }

        // å¸æ©ŸåŠŸèƒ½
        function goOnline() {
            socket.emit('driver:online')
            addEvent('ğŸŸ¢ å¸æ©Ÿä¸Šç·š', 'success')
        }

        function goOffline() {
            addEvent('ğŸ”´ å¸æ©Ÿä¸‹ç·š', 'warning')
        }

        function updateLocation() {
            const lat = document.getElementById('latitude').value
            const lng = document.getElementById('longitude').value
            socket.emit('driver:location', { latitude: parseFloat(lat), longitude: parseFloat(lng) })
            addEvent(`ğŸ“ æ›´æ–°ä½ç½®ï¼š${lat}, ${lng}`, 'info')
        }

        function acceptOrder() {
            const orderId = document.getElementById('orderId').value
            if (orderId) {
                socket.emit('driver:accept-order', { orderId })
                addEvent(`âœ… æ¥å—è¨‚å–®ï¼š${orderId}`, 'success')
            }
        }

        // ä¹˜å®¢åŠŸèƒ½
        function trackOrder() {
            const orderId = document.getElementById('passengerOrderId').value
            if (orderId) {
                // é‡æ–°é€£ç·šä¸¦å¸¶å…¥è¨‚å–®ID
                if (socket) {
                    socket.disconnect()
                }
                socket = io('http://localhost:3000', {
                    auth: { token },
                    query: { role: 'passenger', orderId }
                })
                addEvent(`ğŸ“ é–‹å§‹è¿½è¹¤è¨‚å–®ï¼š${orderId}`, 'info')
            }
        }

        // è»ŠéšŠç®¡ç†å“¡åŠŸèƒ½
        function requestFleetStats() {
            // è»ŠéšŠçµ±è¨ˆæœƒè‡ªå‹•æ¯5ç§’æ¨é€
            addEvent('ğŸ“Š è«‹æ±‚è»ŠéšŠçµ±è¨ˆ...', 'info')
        }

        function addEvent(message, type = 'info') {
            const log = document.getElementById('eventLog')
            const event = document.createElement('div')
            event.className = 'event'
            
            const time = new Date().toLocaleTimeString()
            
            let color = '#00ff00'
            if (type === 'error') color = '#ff0000'
            if (type === 'success') color = '#00ff00'
            if (type === 'warning') color = '#ffff00'
            
            event.innerHTML = `<span style="color: #888;">[${time}]</span> <span style="color: ${color};">${message}</span>`
            log.appendChild(event)
            log.scrollTop = log.scrollHeight
        }

        // é è¨­é¸æ“‡å¸æ©Ÿè§’è‰²
        setTimeout(() => {
            document.querySelector('.role-btn').click()
        }, 100)
    </script>
</body>
</html>